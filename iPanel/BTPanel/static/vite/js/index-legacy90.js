System.register(["./page_layout-legacy.js?v=1752142539265","./campaign-legacy.js?v=1752142539265","./vue-legacy.js?v=1752142539265","./public-legacy.js?v=1752142539265","./naive-legacy.js?v=1752142539265","./index.vue_vue_type_script_setup_true_lang-legacy3.js?v=1752142539265","./common-legacy.js?v=1752142539265","./__commonjsHelpers__-legacy.js?v=1752142539265","./mail-legacy.js?v=1752142539265"],(function(e,t){"use strict";var a,l,n,o,i,r,s,d,u,c,p,f,v,y,b,m,g,_,k,h,x,w,K,N,j,C,U,z,E,S,D,$,A,P,R,I,W,T,O,L,V,M,q,B,G,F,H,Y,Z,Q,X,J,ee,te,ae,le,ne;return{setters:[e=>{a=e.d,l=e.m,n=e.g,o=e._,i=e.e,r=e.M,s=e.w,d=e.N,u=e.p,c=e.j,p=e.O},e=>{f=e.e,v=e.g,y=e.a,b=e.b,m=e.c},e=>{g=e.r,_=e.Q,k=e.j,h=e.F,x=e.N,w=e.k,K=e.av,N=e.c,j=e.a1,C=e.X,U=e.a2,z=e.V,E=e.U,S=e.O,D=e.a3,$=e.W,A=e.an,P=e.a6,R=e.H,I=e.au,W=e.a4,T=e.e,O=e.l,L=e.v,V=e.Z,M=e.aj,q=e.G},e=>{B=e.d},e=>{G=e.cB,F=e.cC,H=e.bM,Y=e.bS,Z=e.b$,Q=e.cz,X=e.cD,J=e.aq,ee=e.cE,te=e.c1,ae=e.bZ,le=e.ay},e=>{ne=e._},null,null,null],execute:function(){var t=document.createElement("style");t.textContent=".tool-icon[data-v-4e70f650]{width:18px;height:18px;border:1px dashed #bababa;background-color:#f9f9f9;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s}.tool-icon[data-v-4e70f650]:hover{width:40px;border-color:#20a53a}.add-node[data-v-4e70f650]{max-width:510px;box-sizing:border-box;padding:10px;background:#fff}.add-node .header[data-v-4e70f650]{text-align:center;font-weight:700;font-size:16px}.add-node .node-list[data-v-4e70f650]{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-start;margin-top:20px}.add-node .node-list .node-item[data-v-4e70f650]{width:90px;height:90px;background:#f3f4f6;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;cursor:pointer}.email-box[data-v-8d632fb4]{display:flex;align-items:center;justify-content:center;width:100%;height:176px;background-color:#fafafa;border-top-left-radius:6px;border-top-right-radius:6px}.normal-node[data-v-1237c863]{padding:24px 32px;text-align:center;font-size:14px}.line[data-v-0b2e1f55]{width:1px;height:24px;background-color:#d1d5db}.tools-box[data-v-0b2e1f55]{display:flex;flex-direction:column;align-items:center}.node-box[data-v-0b2e1f55]{position:relative;width:256px;min-height:50px;border:1px solid rgba(209,213,219,.5);background-color:#fff;border-radius:6px;transition:all .3s;cursor:pointer}.node-box[data-v-0b2e1f55]:hover{border-color:#d1d5db}.node-box .node-title[data-v-0b2e1f55]{position:absolute;top:8px;left:8px;display:flex;align-items:center;justify-content:center;gap:6px}.node-box .node-title .icon[data-v-0b2e1f55]{font-size:16px}.node-box .node-title .text[data-v-0b2e1f55]{font-size:12px;color:#999}.node-box .del-node[data-v-0b2e1f55]{position:absolute;right:8px;top:8px;font-size:14px}.node-box.warning[data-v-0b2e1f55]{border-color:rgba(253,202,98,.7)}.node-box.warning[data-v-0b2e1f55]:hover{border-color:#fdca62;box-shadow:0 0 1px 3px rgba(253,202,98,.2)}.node-box.action[data-v-0b2e1f55],.node-box.action[data-v-0b2e1f55]:hover{border-color:#20a53a;box-shadow:0 0 1px 3px rgba(32,165,58,.2)}.line[data-v-fbf5dbc0]{width:1px;height:24px;background-color:#d1d5db}.tools-box[data-v-fbf5dbc0]{display:flex;flex-direction:column;align-items:center}.node-box[data-v-fbf5dbc0]{position:relative;width:256px;padding:24px 32px;border:1px solid rgba(209,213,219,.5);background-color:#fff;border-radius:6px;transition:all .3s;cursor:pointer}.node-box[data-v-fbf5dbc0]:hover{border-color:#d1d5db}.node-box .node-title[data-v-fbf5dbc0]{position:absolute;top:8px;left:8px;display:flex;align-items:center;justify-content:center;gap:6px}.node-box .node-title .icon[data-v-fbf5dbc0]{font-size:16px}.node-box .node-title .text[data-v-fbf5dbc0]{font-size:12px;color:#999}.node-box .del-node[data-v-fbf5dbc0]{position:absolute;right:8px;top:8px;font-size:14px}.node-box.warning[data-v-fbf5dbc0]{border-color:rgba(253,202,98,.7)}.node-box.warning[data-v-fbf5dbc0]:hover{border-color:#fdca62;box-shadow:0 0 1px 3px rgba(253,202,98,.2)}.node-box.warning .node-title .icon[data-v-fbf5dbc0]{color:#fdca62}.node-box.action[data-v-fbf5dbc0],.node-box.action[data-v-fbf5dbc0]:hover{border-color:#20a53a;box-shadow:0 0 1px 3px rgba(32,165,58,.2)}.condition-box[data-v-fbf5dbc0]{display:flex}.condition-box .condition-item[data-v-fbf5dbc0]{position:relative;display:flex;flex-direction:column;align-items:center;min-width:288px}.horizontal-line[data-v-fbf5dbc0]{position:absolute;top:0;right:0;width:50%;height:1px;background-color:#d1d5db}.horizontal-line.left[data-v-fbf5dbc0]{left:0}.horizontal-line.right[data-v-fbf5dbc0]{right:0}.flow-tree[data-v-fbf5dbc0],.flow-tree li[data-v-fbf5dbc0]{display:flex;flex-direction:column;align-items:center}.condition-state[data-v-fbf5dbc0]{display:flex;align-items:center;justify-content:center;width:48px;height:32px;border-radius:4px;color:#fff}.condition-state.success[data-v-fbf5dbc0]{background-color:#20a53a}.condition-state.fail[data-v-fbf5dbc0]{background-color:#ef0808}.flow-container[data-v-459fbb31]{flex:1;position:relative;width:100%;height:100%;padding:32px;background-color:#f3f4f6;overflow:auto}.flow-container .flow-tree[data-v-459fbb31],.flow-container .flow-tree li[data-v-459fbb31]{display:flex;flex-direction:column;align-items:center}.test-box[data-v-459fbb31]{width:300px;height:60px;background:#f30}.condition-box[data-v-00442d4d]{margin-top:12px;padding:12px;border:1px solid #d9d9d9;border-radius:4px}.flow-config[data-v-56456025]{display:flex;flex-direction:column;width:380px;height:100%;border-left:1px solid #e5e7eb;overflow:hidden}.config-title[data-v-56456025]{padding-top:16px;padding-bottom:16px;text-align:center;line-height:20px;border-bottom:1px solid #e5e7eb}.config-footer[data-v-56456025]{display:flex;justify-content:flex-end;padding:16px 20px;border-top:1px solid #e5e7eb}.mail-flow[data-v-b7d1832f]{display:flex;flex-direction:column;width:100%;height:100%}\n/*$vite$:1*/",document.head.appendChild(t);const oe=g(0),ie=g([]),re=g([]),se=g(Date.now()),de=g("root"),ue=g("trigger"),ce=g({root:{nodeKey:"root",parentNodeKey:"",type:"trigger",id:0,parent_id:0,broken:!1,complete:!0,config:{type:"subscriber_added",group_ids:[]}}}),pe=g({}),fe=g({}),ve=g({}),ye=g({}),be=g({}),me=g({}),ge=g({trigger:ce,email:pe,delay:fe,webhook:ve,action:ye,abTest:be,condition:me}),_e=g({nodeKey:"",parentNodeKey:"",type:"trigger",next:null,id:0,parent_id:0,broken:!1,complete:!1}),ke=g({..._e.value,config:{type:"subscriber_added",group_ids:[]}}),he=g({..._e.value,email_id:0,name:"",subject:"",from:"",from_name:"",track_opens:!0,track_clicks:!0,track_unsubscribe:!0}),xe=g({..._e.value,value:0,unit:"days",description:""}),we=g({..._e.value,url:"",secret:""}),Ke=g({..._e.value,action:"add_to_subscribers",group_ids:[],description:""}),Ne=g({..._e.value,name:"",branches:[]}),je=g({..._e.value,rules:[{type:null}],logic_type:"or",yes:[],no:[],description:""}),Ce=g({trigger:ke,email:he,delay:xe,webhook:we,action:Ke,abTest:Ne,condition:je}),Ue={events:{},$on(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},$emit(e,t){this.events[e].forEach((e=>{e(t)}))},$unsubscribe(e){this.events[e]=[]}};function ze(e,t){const a="trigger"===e?"root":n(),l=Y(Ce.value[e]);return l.nodeKey=a,l.parentNodeKey=t,l.type=e,ge.value[e][a]=l,l}function Ee(e,t){const a=ze(e,t);return me.value[t].no.unshift({type:e,key:a.nodeKey}),"condition"==e&&Ue.$on(a.nodeKey,(()=>{!function(e,t){const a=me.value[t].no.findIndex((t=>t.key==e));me.value[t].no.splice(a,1),Ue.$unsubscribe(e)}(a.nodeKey,t)})),a}function Se(e,t){const a=me.value[e],{parentNodeKey:l}=a;a[t].forEach((t=>{if("trigger"!==t.type&&(ge.value[t.type][t.key].parentNodeKey=a.parentNodeKey),"root"===l)re.value.push({type:t.type,key:t.key});else{const a=me.value[l],n=function(e){const t=me.value[e],a=t.parentNodeKey,l=me.value[a];return l.yes.some((t=>t.key===e))?"yes":"no"}(e);a[n].push({type:t.type,key:t.key})}}))}function De(e,t){const a=re.value.findIndex((e=>e.key==t));re.value.splice(a,1),delete ge.value[e][t]}function $e(e){const t=g(1),a=ge.value.condition[e],l=a.yes.length>0||a.no.length>0;B({title:"Please choose one of the following",width:400,content:()=>_(h,null,[l&&_(G,{value:t.value,onUpdateValue:e=>t.value=e},{default:()=>[_("div",null,[_(F,{value:1},{default:()=>[k("Delete both branches including all steps below.")]})]),_("div",{class:"mt-6px"},[_(F,{value:2},{default:()=>[k("Delete only YES branch including steps below.")]})]),_("div",{class:"mt-6px"},[_(F,{value:3},{default:()=>[k("Delete only NO branch including steps below.")]})])]}),!l&&_("div",null,[k("Do you really want to delete this step?")])]),onConfirm:async()=>{switch(t.value){case 1:Ae(e),Pe(e),Re(e);break;case 2:Ae(e),Se(e,"no"),Re(e);break;case 3:Pe(e),Se(e,"yes"),Re(e)}await Be(),de.value===e&&(se.value=Date.now(),de.value="root",ue.value="trigger")}})}function Ae(e){me.value[e].yes.forEach((t=>{var a;"trigger"!==t.type&&("condition"!==t.type?Ie(t.type,e,t.key):(Ae(a=t.key),Ue.$emit(a)))}))}function Pe(e){me.value[e].no.forEach((t=>{var a;"trigger"!==t.type&&("condition"!==t.type?We(t.type,e,t.key):(Pe(a=t.key),Ue.$emit(a)))}))}function Re(e){const t=me.value[e],{parentNodeKey:a}=t;if("root"===a)De("condition",e);else{const t=me.value[a];let l=t.yes.findIndex((t=>t.key===e));l>-1?t.yes.splice(l,1):(l=t.no.findIndex((t=>t.key===e)),t.no.splice(l,1))}}function Ie(e,t,a){const l=me.value[t].yes.findIndex((e=>e.key==a));me.value[t].yes.splice(l,1),delete ge.value[e][a]}function We(e,t,a){const l=me.value[t].no.findIndex((e=>e.key==a));me.value[t].no.splice(l,1),delete ge.value[e][a]}function Te(e,t){const a=me.value[t].yes.findIndex((t=>t.key==e));me.value[t].yes.splice(a,1),Ue.$unsubscribe(e)}function Oe(e){Ge();const{root:t,triggers:a}=e;H(a)&&a.length>0&&("subscriber_added"===a[0].type&&(ge.value.trigger.root.complete=a[0].group_ids.length>0),ge.value.trigger.root.config=a[0]),re.value=Le(t,"root")}function Le(e,t,a=!1){const l=[];let n=e;for(;n;){const e=n.nodeKey,i={key:e,type:n.type};if(l.push(i),"condition"===n.type){a&&Ue.$on(e,(()=>{Te(e,t)})),ge.value.condition[e]=Ve(n,e);break}ge.value[n.type][e]=(o=n,{...o,next:null}),n=n.next}var o;return l}function Ve(e,t){return{...e,nodeKey:t,yes:Le(e.yes,t,!0),no:Le(e.no,t,!0),next:null}}function Me(e){return e.reduceRight(((e,t)=>{const a=ge.value[t.type][t.key],l=Y(a);return"condition"===l.type?{...(n=l,{...n,yes:Me(n.yes),no:Me(n.no),next:null}),next:e}:{...l,next:e};var n}),null)}async function qe(){const{message:e}=await v({id:oe.value});a(e)&&Oe(e)}async function Be(e="save"){const t=function(){const e=Me(re.value);return{triggers:[x(ge.value.trigger.root.config)],root:e}}(),{message:n}=await f({id:oe.value,...t});if(a(n)){switch(e){case"save":l.success("Save successfully");break;case"del":l.success("Node deleted successfully");break;case"add":l.success("Node added successfully")}Oe(n)}}async function Ge(){re.value=[],Object.keys(ge.value).forEach((e=>{"trigger"!==e&&(ge.value[e]={})}))}function Fe(){se.value=Date.now(),de.value="root",ue.value="trigger"}const He={class:"tool-icon"},Ye={class:"add-node"},Ze={class:"node-list"},Qe=["onClick"],Xe=w({__name:"ToolAdd",props:{parentKey:{},parentType:{},last:{type:Boolean}},emits:["addNode"],setup(e,{emit:t}){const a=e,l=t,n=K("popoverRef"),i=g([{type:"email",icon:"",desc:"Email"},{type:"delay",icon:"",desc:"Delay"},{type:"webhook",icon:"",desc:"Webhook"}]),r=N((()=>a.last?i.value:i.value.filter((e=>"condition"!==e.type))));return(e,t)=>{const i=o,s=Z;return C(),j(s,{ref_key:"popoverRef",ref:n,trigger:"click"},{trigger:U((()=>[z("div",He,[_(i,{name:"base-add",size:"16"})])])),default:U((()=>[z("div",Ye,[t[0]||(t[0]=z("div",{class:"header"},"Add a next step to your workflow",-1)),z("div",Ze,[(C(!0),E(h,null,S($(r),(e=>(C(),E("div",{key:e.type,class:"node-item",onClick:t=>{return o=e.type,l("addNode",o,a.parentKey),void n.value?.setShow(!1);var o}},D(e.desc),9,Qe)))),128))])])])),_:1},512)}}}),Je=i(Xe,[["__scopeId","data-v-4e70f650"]]),et={class:"normal-node"},tt={key:0,class:"font-bold"},at=w({__name:"TriggerNode",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>ce.value[t.nodeKey])),l=N((()=>{const{config:e}=a.value;if("subscriber_added"===e.type&&0===e.group_ids.length)return"Set up workflow trigger";switch(e.type){case"subscriber_added":return"When a new email joins group(s) ";case"subscribed":return"When subscriber joins group(s) ";case"opened":return"When subscriber opens an email ";case"clicked":return`When subscriber clicks a link ${e.link} `;case"unsubscribed":return"When subscriber unsubscribes ";default:return"Set up workflow trigger "}})),n=N((()=>{const{config:e}=a.value;switch(e.type){case"subscriber_added":case"subscribed":return o(e.group_ids);case"clicked":return e.link.url}return""})),o=e=>ie.value.filter((t=>e.includes(t.id))).map((e=>e.mail_type)).join(", ");return(e,t)=>(C(),E("div",et,[z("span",null,D($(l)),1),$(n)?(C(),E("span",tt,D($(n)),1)):A("",!0)]))}}),lt={class:"normal-node"},nt={class:"mt-8px"},ot={key:0,class:"font-bold"},it=w({__name:"ActionNode",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>ye.value[t.nodeKey])),l=N((()=>{if(a.value.complete&&a.value.group_ids.length>0)switch(a.value.action){case"add_to_subscribers":return"Add to group(s) ";case"remove_from_subscribers":return"Remove from group(s) ";case"mark_as_unsubscribe":return"Mark as unsubscribed"}return"Define action"})),n=N((()=>{if(a.value.complete)switch(a.value.action){case"add_to_subscribers":case"remove_from_subscribers":return i(a.value.group_ids)}return""})),i=e=>ie.value.filter((t=>e.includes(t.id))).map((e=>e.mail_type)).join(", ");return(e,t)=>{const a=o;return C(),E("div",lt,[z("div",null,[_(a,{name:"flow-action",size:"16"})]),z("div",nt,[z("span",null,D($(l)),1),$(n)?(C(),E("span",ot,D($(n)),1)):A("",!0)])])}}}),rt={class:"normal-node"},st={class:"mt-8px"},dt=w({__name:"DelayNode",props:{type:{default:"delay"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>fe.value[t.nodeKey])),l=N((()=>a.value.complete?`Wait ${a.value.value} ${a.value.unit}`:"Set delay"));return(e,t)=>{const a=o;return C(),E("div",rt,[z("div",null,[_(a,{name:"flow-delay",size:"16"})]),z("div",st,D($(l)),1)])}}}),ut={class:"normal-node"},ct={class:"mt-8px"},pt=i(w({__name:"EmailNode",props:{type:{default:"email"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>pe.value[t.nodeKey])),l=N((()=>a.value.complete?a.value.name:"Set email"));return(e,t)=>{const a=o;return C(),E("div",ut,[z("div",null,[_(a,{name:"flow-email",size:"16"})]),z("div",ct,D($(l)),1)])}}}),[["__scopeId","data-v-8d632fb4"]]),ft={class:"normal-node"},vt={class:"mt-8px"},yt=w({__name:"WebhookNode",props:{type:{default:"webhook"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>ve.value[t.nodeKey])),l=N((()=>a.value.complete?a.value.url:"Set webhook"));return(e,t)=>{const a=o;return C(),E("div",ft,[z("div",null,[_(a,{name:"flow-webhook",size:"16"})]),z("div",vt,D($(l)),1)])}}}),bt=i({},[["render",function(e,t){return C(),E("div")}]]),mt=i(w({__name:"index",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>{switch(t.type){case"trigger":return at;case"delay":return dt;case"action":return it;case"email":return pt;case"webhook":return yt;default:return bt}}));return(e,t)=>(C(),j(P($(a)),{type:e.type,"node-key":e.nodeKey},null,8,["type","node-key"]))}}),[["__scopeId","data-v-1237c863"]]),gt={key:0,class:"line"},_t={class:"node-title"},kt={key:1,class:"text"},ht={class:"tools-box"},xt=w({__name:"NormalNode",props:{last:{type:Boolean,default:!1},type:{default:"trigger"},nodeKey:{default:"root"}},emits:["addNode","delNormalNode","selectNode"],setup(e,{emit:t}){const a=e,n=t,i=N((()=>"trigger"!==a.type)),s=N((()=>!u.value.complete)),d=N((()=>a.nodeKey===de.value)),u=N((()=>ge.value[a.type][a.nodeKey])),c=N((()=>a.type?r(a.type):""));function p(){n("selectNode",a.type,a.nodeKey)}function f(e){n("addNode",e,u.value)}function v(){if("email"===a.type){let e=!1;const t=ge.value.email[a.nodeKey],n=ge.value.condition,o=Object.entries(n);for(const[,a]of o){if(a.complete&&a.rules.length>0)for(const l of a.rules)if("workflow"===l.type&&l.node_id===t.id){e=!0;break}if(e)break}if(e)return void l.error("The email node is used in the condition node and cannot be deleted",{close:!0})}B({title:"Please confirm",content:"Do you really want to delete this step?",onConfirm:async()=>{n("delNormalNode",a.type,a.nodeKey),await Be("del")}})}return(e,t)=>{const a=o;return C(),E(h,null,[$(i)?(C(),E("div",gt)):A("",!0),z("div",{class:R(["node-box",{warning:$(s),action:$(d)}]),onClick:p},[z("div",_t,[$(s)?(C(),j(a,{key:0,class:"icon",name:"warning",color:"#FDCA62"})):A("",!0),$(i)?(C(),E("span",kt,D($(c)),1)):A("",!0)]),$(i)?(C(),E("span",{key:0,class:"del-node",onClick:I(v,["stop"])},[_(a,{name:"flow-del"})])):A("",!0),_(mt,{type:e.type,"node-key":e.nodeKey},null,8,["type","node-key"])],2),z("div",ht,[t[0]||(t[0]=z("div",{class:"line"},null,-1)),z("div",null,[_(Je,{last:e.last,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:f},null,8,["last","parent-type","parent-key"])])])],64)}}}),wt=i(xt,[["__scopeId","data-v-0b2e1f55"]]),Kt={class:"node-title"},Nt={class:"text-center"},jt={class:"mt-12px text-14px text-center"},Ct={key:0,class:"font-bold"},Ut={class:"tools-box"},zt={class:"condition-box"},Et={class:"condition-item"},St={class:"condition-state success"},Dt={class:"tools-box"},$t={key:0,class:"flow-tree"},At={class:"condition-item"},Pt={class:"condition-state fail"},Rt={class:"tools-box"},It={key:0,class:"flow-tree"},Wt=w({name:"ConditionNode",__name:"ConditionNode",props:{type:{default:"trigger"},nodeKey:{default:"root"}},emits:["delCondition","selectNode"],setup(e,{emit:t}){const a=e,l=t,n=N((()=>!r.value.complete)),i=N((()=>a.nodeKey===de.value)),r=N((()=>me.value[a.nodeKey])),s=new Map([["clicked"," had any link clicked"],["link_clicked"," had a specific link clicked"],["link_not_clicked"," did not have a specific link clicked"],["opened"," was opened"],["not_opened"," was not opened"],["opened_with_not_clicked"," was opened with no links clicked"]]),d=N((()=>{const{rules:e}=r.value;if(e.length>0&&null!==e[0].type)switch(e[0].type){case"campaign":return e[0].campaign.name;case"workflow":return function(e,t){const a=ge.value[t],l=Object.entries(a).filter((([,t])=>t.id===e));return l.length>0?l[0][1].name:""}(e[0].node_id,"email")}return""})),u=N((()=>{const{complete:e,rules:t,logic_type:a}=r.value;if(e&&t.length>0&&null!==t[0].type){let e=s.get(t[0].action)||"";return t.length>1&&(e+=` ${a} +${t.length-1} condition`),e}return"Define condition"})),c=()=>{l("selectNode","condition",a.nodeKey)},p=(e,t)=>{l("selectNode",e,t)};async function f(e,t){const a=function(e,t){const a=ze(e,t);return me.value[t].yes.unshift({type:e,key:a.nodeKey}),"condition"==e&&Ue.$on(a.nodeKey,(()=>{Te(a.nodeKey,t)})),a}(e,t);await Be("add"),p(a.type,a.nodeKey)}async function v(e){const t=function(e,t){const a=ze(e,t);return me.value[t].yes.push({type:e,key:a.nodeKey}),a}(e,a.nodeKey);await Be("add"),p(t.type,t.nodeKey)}async function y(e,t){const a=Ee(e,t);await Be("add"),p(a.type,a.nodeKey)}async function b(e){const t=function(e,t){const a=ze(e,t);return me.value[t].no.push({type:e,key:a.nodeKey}),a}(e,a.nodeKey);await Be("add"),p(t.type,t.nodeKey)}function m(){l("delCondition",a.nodeKey)}function g(e){$e(e)}function k(e,t){Ie(e,a.nodeKey,t),de.value===t&&p("trigger","root")}function x(e,t){We(e,a.nodeKey,t),de.value===t&&p("trigger","root")}return(e,t)=>{const a=o,l=W("ConditionNode",!0);return C(),E(h,null,[t[8]||(t[8]=z("div",{class:"line"},null,-1)),z("div",{class:R(["node-box",{warning:$(n),action:$(i)}]),onClick:c},[z("div",Kt,[$(n)?(C(),j(a,{key:0,class:"icon",name:"warning"})):A("",!0),t[0]||(t[0]=z("span",{class:"text"},"Condition",-1))]),z("span",{class:"del-node",onClick:I(m,["stop"])},[_(a,{name:"flow-del"})]),z("div",Nt,[_(a,{size:"16",name:"flow-condition"})]),z("div",jt,[$(d)?(C(),E("span",Ct,D($(d)),1)):A("",!0),z("span",null,D($(u)),1)])],2),z("div",Ut,[t[7]||(t[7]=z("div",{class:"line"},null,-1)),z("div",zt,[z("div",Et,[t[2]||(t[2]=z("div",{class:"horizontal-line right"},null,-1)),t[3]||(t[3]=z("div",{class:"line"},null,-1)),z("div",St,[_(a,{name:"flow-success",size:"20"})]),z("div",Dt,[t[1]||(t[1]=z("div",{class:"line"},null,-1)),z("div",null,[_(Je,{last:0===$(r).yes.length,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:f},null,8,["last","parent-type","parent-key"])])]),$(r).yes.length?(C(),E("ul",$t,[(C(!0),E(h,null,S($(r).yes,((e,t)=>(C(),E("li",{key:e.key},["condition"==e.type?(C(),j(l,{key:0,type:"condition","node-key":e.key,onSelectNode:p,onDelCondition:g},null,8,["node-key"])):(C(),j(wt,{key:1,last:t===$(r).yes.length-1,type:e.type,"node-key":e.key,onAddNode:v,onSelectNode:p,onDelNormalNode:k},null,8,["last","type","node-key"]))])))),128))])):A("",!0)]),z("div",At,[t[5]||(t[5]=z("div",{class:"horizontal-line left"},null,-1)),t[6]||(t[6]=z("div",{class:"line"},null,-1)),z("div",Pt,[_(a,{name:"flow-fail",size:"20"})]),z("div",Rt,[t[4]||(t[4]=z("div",{class:"line"},null,-1)),z("div",null,[_(Je,{last:0===$(r).no.length,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:y},null,8,["last","parent-type","parent-key"])])]),$(r).no.length?(C(),E("ul",It,[(C(!0),E(h,null,S($(r).no,((e,t)=>(C(),E("li",{key:e.key},["condition"==e.type?(C(),j(l,{key:0,type:"condition","node-key":e.key,onSelectNode:p,onDelCondition:g},null,8,["node-key"])):(C(),j(wt,{key:1,last:t===$(r).no.length-1,type:e.type,"node-key":e.key,onAddNode:b,onSelectNode:p,onDelNormalNode:x},null,8,["last","type","node-key"]))])))),128))])):A("",!0)])])])],64)}}}),Tt=i(Wt,[["__scopeId","data-v-fbf5dbc0"]]),Ot={class:"flow-container"},Lt={class:"flow-tree"},Vt=w({__name:"index",setup(e){async function t(e,t){const a=function(e,t){const a=ze(e,"root");if(""===t)re.value.unshift({type:e,key:a.nodeKey});else{const l=re.value.findIndex((e=>e.key==t));re.value.splice(l+1,0,{type:e,key:a.nodeKey})}return a}(e,t.nodeKey);await Be("add"),n(a.type,a.nodeKey)}function a(e){$e(e)}function l(e,t){De(e,t),de.value===t&&n("trigger","root")}function n(e,t){se.value=Date.now(),ue.value=e,de.value=t}return(e,o)=>(C(),E("div",Ot,[z("ul",Lt,[z("li",null,[_(wt,{last:0===$(re).length,type:"trigger","node-key":"root",onSelectNode:n,onAddNode:t},null,8,["last"])]),(C(!0),E(h,null,S($(re),((e,o)=>(C(),E("li",{key:e.key},["condition"==e.type?(C(),j(Tt,{key:0,type:"condition","node-key":e.key,onSelectNode:n,onDelCondition:a},null,8,["node-key"])):(C(),j(wt,{key:1,last:o===$(re).length-1,type:e.type,"node-key":e.key,onAddNode:t,onSelectNode:n,onDelNormalNode:l},null,8,["last","type","node-key"]))])))),128))])]))}}),Mt=i(Vt,[["__scopeId","data-v-459fbb31"]]),qt={class:"p-20px"},Bt=w({__name:"TriggerConfig",setup(e,{expose:t}){const a=K("formRef"),l=g({type:"subscriber_added",group_ids:[]}),n={group:{trigger:["change"],validator:()=>!!("subscriber_added"!==l.value.type&&"subscribed"!==l.value.type||l.value.group_ids.length)||new Error("Please select group")},link:{trigger:["input","blur"],validator:()=>!("clicked"===l.value.type&&!l.value.link.url)||new Error("Please enter link")}},o=g([{label:"When a new email joins group(s)",value:"subscriber_added"}]),i=g([]),r=e=>{switch(e){case"subscriber_added":case"subscribed":l.value={type:e,group_ids:[]};break;case"clicked":l.value={type:e,link:{url:""}};break;case"opened":case"unsubscribed":l.value={type:e}}};return(()=>{if((async()=>{i.value=ie.value.map((e=>({label:e.mail_type,value:e.id})))})(),de.value){const e=ce.value[de.value];e&&(l.value=Y(e.config))}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=ce.value[de.value];e.config=Y(l.value),e.complete=!0}}}),(e,t)=>{const s=X,d=Q,u=J,c=ee;return C(),E("div",qt,[_(c,{ref_key:"formRef",ref:a,model:$(l),rules:n},{default:U((()=>[_(d,{label:"Trigger"},{default:U((()=>[_(s,{value:$(l).type,options:$(o),"onUpdate:value":r},null,8,["value","options"])])),_:1}),"subscriber_added"===$(l).type||"subscribed"===$(l).type?(C(),j(d,{key:0,label:"Group",path:"group"},{default:U((()=>[_(s,{value:$(l).group_ids,"onUpdate:value":t[0]||(t[0]=e=>$(l).group_ids=e),multiple:!0,filterable:!0,options:$(i)},null,8,["value","options"])])),_:1})):A("",!0),"clicked"===$(l).type?(C(),j(d,{key:1,label:"Link",path:"link"},{default:U((()=>[_(u,{value:$(l).link.url,"onUpdate:value":t[1]||(t[1]=e=>$(l).link.url=e)},null,8,["value"])])),_:1})):A("",!0)])),_:1},8,["model"])])}}}),Gt={class:"p-20px"},Ft=w({__name:"EmailConfig",setup(e,{expose:t}){const l=K("formRef"),n=T({name:"",subject:"",from_name:"",from:"",email_id:null,track_opens:!0,track_clicks:!0,track_unsubscribe:!0}),o=g([]),i={email_id:{trigger:["change"],validator:()=>!!n.email_id||new Error("Please select email template")},name:{trigger:["blur","input"],validator:()=>!!n.name||new Error("Please enter email name")},subject:{trigger:["blur","input"],validator:()=>!!n.subject||new Error("Please enter email subject")},from_name:{trigger:["blur","input"],validator:()=>!!n.from_name||new Error("Please enter sender name")},from:{trigger:["blur","input"],validator:()=>n.from?!!d(n.from)||new Error("Please enter a valid email address"):new Error("Please enter sender email")}},r=(e,t)=>{const{data:l}=t;a(l)&&(n.from_name=l.full_name)},u=async()=>{const{message:e}=await y();s(e)&&e.length>0&&(o.value=e.map((e=>({label:e.name,value:e.id}))))};return(()=>{if(u(),de.value){const e=pe.value[de.value];n.name=e.name,n.subject=e.subject,n.from_name=e.from_name,n.from=e.from,n.email_id=0===e.email_id?null:e.email_id,n.track_opens=e.track_opens,n.track_clicks=e.track_clicks,n.track_unsubscribe=e.track_unsubscribe}})(),t({submit:async()=>{if(await(l.value?.validate()),de.value){const e=pe.value[de.value];e.name=n.name,e.subject=n.subject,e.from_name=n.from_name,e.from=n.from,e.email_id=null===n.email_id?0:n.email_id,e.track_opens=n.track_opens,e.track_clicks=n.track_clicks,e.track_unsubscribe=n.track_unsubscribe,e.complete=!0}}}),(e,t)=>{const a=J,s=Q,d=X,u=te,c=ee;return C(),E("div",Gt,[_(c,{ref_key:"formRef",ref:l,model:$(n),rules:i},{default:U((()=>[_(s,{label:"Email name",path:"name"},{default:U((()=>[_(a,{value:$(n).name,"onUpdate:value":t[0]||(t[0]=e=>$(n).name=e),placeholder:"Name"},null,8,["value"])])),_:1}),_(s,{label:"Sender email",path:"from"},{default:U((()=>[_(ne,{value:$(n).from,"onUpdate:value":t[1]||(t[1]=e=>$(n).from=e),"is-init":!0,placeholder:"Sender email",onChange:r},null,8,["value"])])),_:1}),_(s,{label:"Who is it from?",path:"from_name"},{default:U((()=>[_(a,{value:$(n).from_name,"onUpdate:value":t[2]||(t[2]=e=>$(n).from_name=e),placeholder:"Sender name"},null,8,["value"])])),_:1}),_(s,{label:"Subject",path:"subject"},{default:U((()=>[_(a,{value:$(n).subject,"onUpdate:value":t[3]||(t[3]=e=>$(n).subject=e),placeholder:"Email subject"},null,8,["value"])])),_:1}),_(s,{label:"Template",path:"email_id"},{default:U((()=>[_(d,{value:$(n).email_id,"onUpdate:value":t[4]||(t[4]=e=>$(n).email_id=e),options:$(o)},null,8,["value","options"])])),_:1}),A("",!0),A("",!0),_(s,{label:"Whether to enable the unsubscribe link and collect unsubscribe statistics"},{default:U((()=>[_(u,{value:$(n).track_unsubscribe,"onUpdate:value":t[7]||(t[7]=e=>$(n).track_unsubscribe=e)},null,8,["value"])])),_:1})])),_:1},8,["model"])])}}}),Ht={class:"p-20px"},Yt={class:"w-140px mr-12px"},Zt={class:"flex-1"},Qt=w({__name:"DelayConfig",setup(e,{expose:t}){const a=K("formRef"),l=T({value:0,unit:"days"}),n=g([{label:"second(s)",value:"seconds"},{label:"minute(s)",value:"minutes"},{label:"hour(s)",value:"hours"},{label:"day(s)",value:"days"}]),o={value:{trigger:["blur","input"],validator:()=>l.value<=0?new Error("Value must be at least 1"):"days"===l.unit&&l.value>700?new Error("Value must be less than 700"):!!Number.isInteger(l.value)||new Error("Value must be an integer")}};return(()=>{if(de.value){const e=fe.value[de.value];l.value=e.value,l.unit=e.unit}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=fe.value[de.value];e.value=l.value,e.unit=l.unit,e.complete=!0}}}),(e,t)=>{const i=ae,r=X,s=Q,d=ee;return C(),E("div",Ht,[_(d,{ref_key:"formRef",ref:a,model:$(l),rules:o},{default:U((()=>[_(s,{label:"Wait",path:"value"},{default:U((()=>[z("div",Yt,[_(i,{value:$(l).value,"onUpdate:value":t[0]||(t[0]=e=>$(l).value=e),min:0,"show-button":!1},null,8,["value"])]),z("div",Zt,[_(r,{value:$(l).unit,"onUpdate:value":t[1]||(t[1]=e=>$(l).unit=e),options:$(n)},null,8,["value","options"])])])),_:1})])),_:1},8,["model"])])}}}),Xt={class:"p-20px"},Jt=w({__name:"ActionConfig",setup(e,{expose:t}){const a=K("formRef"),l=T({action:"add_to_subscribers",group_ids:[]}),n=g([{label:"添加到联系人列表中",value:"add_to_subscribers"},{label:"从联系人列表中删除",value:"remove_from_subscribers"},{label:"标记为已退订",value:"mark_as_unsubscribe"}]),o=g([]),i={group:{trigger:["change"],validator:()=>!!("add_to_subscribers"!==l.action&&"remove_from_subscribers"!==l.action||l.group_ids.length)||new Error("Please select group")}},r=()=>{l.group_ids=[]};return(()=>{if((async()=>{o.value=ie.value.map((e=>({label:e.mail_type,value:e.id})))})(),de.value){const e=ye.value[de.value];l.action=e.action,l.group_ids=Y(e.group_ids)}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=ye.value[de.value];e.action=l.action,e.group_ids=Y(l.group_ids),e.complete=!0}}}),(e,t)=>{const s=X,d=Q,u=ee;return C(),E("div",Xt,[_(u,{ref_key:"formRef",ref:a,model:$(l),rules:i},{default:U((()=>[_(d,{label:"Choose an action"},{default:U((()=>[_(s,{value:$(l).action,"onUpdate:value":[t[0]||(t[0]=e=>$(l).action=e),r],options:$(n)},null,8,["value","options"])])),_:1}),O(_(d,{label:"Group",path:"group"},{default:U((()=>[_(s,{value:$(l).group_ids,"onUpdate:value":t[1]||(t[1]=e=>$(l).group_ids=e),multiple:!0,filterable:!0,options:$(o)},null,8,["value","options"])])),_:1},512),[[L,"add_to_subscribers"===$(l).action||"remove_from_subscribers"===$(l).action]])])),_:1},8,["model"])])}}}),ea={class:"p-20px"},ta=w({__name:"WebhookConfig",setup(e,{expose:t}){const a=K("formRef"),l=T({url:"",secret:""}),n={url:{required:!0,trigger:["blur","input"],message:"Please enter webhook URL"},secret:{required:!0,trigger:["blur","input"],message:"Please enter secret key"}};return(()=>{if(de.value){const e=ve.value[de.value];l.url=e.url,l.secret=e.secret}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=ve.value[de.value];e.url=l.url,e.secret=l.secret,e.complete=!0}}}),(e,t)=>{const o=J,i=Q,r=ee;return C(),E("div",ea,[_(r,{ref_key:"formRef",ref:a,model:$(l),rules:n},{default:U((()=>[_(i,{label:"Webhook URL",path:"url"},{default:U((()=>[_(o,{value:$(l).url,"onUpdate:value":t[0]||(t[0]=e=>$(l).url=e),placeholder:""},null,8,["value"])])),_:1}),_(i,{label:"Secret Key",path:"secret"},{default:U((()=>[_(o,{value:$(l).secret,"onUpdate:value":t[1]||(t[1]=e=>$(l).secret=e),placeholder:""},null,8,["value"])])),_:1})])),_:1},8,["model"])])}}}),aa={class:"p-20px"},la={class:"flex-1"},na={class:"mt-12px"},oa={class:"mt-12px"},ia={class:"condition-box mt-12px"},ra={class:"flex justify-between items-center mb-16px"},sa=w({__name:"ConditionConfig",setup(e,{expose:t}){const l=K("formRef"),n=T({logic_type:"or",rules:[{type:null}]}),o=g([{label:"Campaign activity",value:"campaign"},{label:"Workflow activity",value:"workflow"}]),i=g([]),r=g([]),d=g([{label:"had any link clicked",value:"clicked"},{label:"had a specific link clicked",value:"link_clicked"},{label:"did not have a specific link clicked",value:"link_not_clicked"},{label:"was opened",value:"opened"},{label:"was not opened",value:"not_opened"},{label:"was opened with no links clicked",value:"opened_with_not_clicked"}]),c=e=>({trigger:"change",validator:()=>!!n.rules[e].type||new Error("Please select type")}),p=e=>({trigger:"change",validator:()=>{const t=n.rules[e];return!("campaign"===t.type&&!t.campaign.id)||new Error("Please select campaign")}}),f=e=>({trigger:"change",validator:()=>{const t=n.rules[e];return!!("workflow"!==t.type&&"campaign"!==t.type||t.action)||new Error("Please select action")}}),v=e=>({trigger:"change",validator:()=>{const t=n.rules[e];return!!("workflow"!==t.type&&"campaign"!==t.type||"link_clicked"!==t.action||t.link.url)||new Error("Please input link")}}),y=()=>{n.rules.push({type:null})};return(()=>{if((async()=>{const{message:e}=await b();s(e)&&(i.value=e.map((e=>({value:e.id,data:e,label:e.subject||e.task_name}))))})(),(()=>{const e=re.value.filter((e=>"email"===e.type)).map((e=>pe.value[e.key])).filter((e=>e.complete&&0!==e.id));r.value=e.map((e=>({label:e.name,value:e.id})))})(),de.value){const e=me.value[de.value];n.logic_type=e.logic_type,n.rules=Y(e.rules)}})(),t({submit:async()=>{if(await(l.value?.validate()),de.value){const e=me.value[de.value];e.logic_type=n.logic_type,e.rules=Y(n.rules),e.complete=!0}}}),(e,t)=>{const s=F,b=G,m=u,g=le,x=X,w=Q,K=J,N=ee;return C(),E("div",aa,[_(N,{ref_key:"formRef",ref:l,model:$(n)},{default:U((()=>[_(w,{label:"Create a condition"},{default:U((()=>[z("div",la,[t[6]||(t[6]=z("div",{class:"text-desc"}," Add up to 5 conditions. Define whether any or all of them must be applicable, for the condition to be met. ",-1)),_(b,{value:$(n).logic_type,"onUpdate:value":t[0]||(t[0]=e=>$(n).logic_type=e)},{default:U((()=>[z("div",na,[_(s,{value:"or"},{default:U((()=>t[1]||(t[1]=[z("div",null,"Any rule",-1),z("div",{class:"mt-8px text-desc"}," Select one or a few conditions where ANY rule can match the criteria. ",-1)]))),_:1,__:[1]})]),z("div",oa,[_(s,{value:"and"},{default:U((()=>t[2]||(t[2]=[z("div",null,"All rules",-1),z("div",{class:"mt-8px text-desc"}," Select one or a few conditions where ALL rules must match the criteria. ",-1)]))),_:1,__:[2]})])])),_:1},8,["value"]),(C(!0),E(h,null,S($(n).rules,((e,l)=>(C(),E(h,{key:l},[0!==l?(C(),j(m,{key:0,class:"mt-12px!","title-placement":"left"},{default:U((()=>[k(D($(n).logic_type),1)])),_:1})):A("",!0),z("div",ia,[z("div",ra,[t[4]||(t[4]=z("span",null,"Condition",-1)),$(n).rules.length>1?(C(),j(g,{key:0,size:"small",onClick:e=>(e=>{n.rules.splice(e,1)})(l)},{default:U((()=>t[3]||(t[3]=[k("Delete")]))),_:2,__:[3]},1032,["onClick"])):A("",!0)]),_(w,{"show-label":!1,path:`rules[${l}].type`,rule:c(l)},{default:U((()=>[_(x,{value:e.type,options:$(o),"onUpdate:value":e=>((e,t)=>{switch(e){case"campaign":n.rules[t]={type:"campaign",action:null,campaign:{id:null,name:""},link:{url:""}};break;case"workflow":n.rules[t]={type:"workflow",node_id:null,action:null,link:{url:""}}}})(e,l)},null,8,["value","options","onUpdate:value"])])),_:2},1032,["path","rule"]),"campaign"===e.type?(C(),j(w,{key:0,"show-label":!1,path:`rules[${l}].campaign.id`,rule:p(l)},{default:U((()=>[_(x,{value:e.campaign.id,"onUpdate:value":[t=>e.campaign.id=t,(e,t)=>((e,t)=>{a(t.data)&&"campaign"===n.rules[e].type&&(n.rules[e].campaign.name=t.data.subject)})(l,t)],options:$(i)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path","rule"])):A("",!0),"workflow"===e.type?(C(),j(w,{key:1,"show-label":!1,path:`rules[${l}].workflow.node_id`},{default:U((()=>[_(x,{value:e.node_id,"onUpdate:value":t=>e.node_id=t,options:$(r)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path"])):A("",!0),"campaign"===e.type&&e.campaign.id||"workflow"===e.type&&e.node_id?(C(),E(h,{key:2},[_(w,{"show-label":!1,path:`rules[${l}].action`,rule:f(l)},{default:U((()=>[_(x,{value:e.action,"onUpdate:value":t=>e.action=t,options:$(d)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path","rule"]),O(_(w,{"show-label":!1,path:`rules[${l}].link.url`,rule:v(l)},{default:U((()=>[_(K,{value:e.link.url,"onUpdate:value":t=>e.link.url=t,placeholder:"Please input link"},null,8,["value","onUpdate:value"])])),_:2},1032,["path","rule"]),[[L,"link_clicked"===e.action]])],64)):A("",!0)])],64)))),128)),_(g,{class:"mt-12px",size:"small",onClick:y},{default:U((()=>t[5]||(t[5]=[k(" Add another condition ")]))),_:1,__:[5]})])])),_:1})])),_:1},8,["model"])])}}}),da=i(sa,[["__scopeId","data-v-00442d4d"]]),ua=i({},[["render",function(e,t){return C(),E("div")}]]),ca={class:"flow-config"},pa={class:"config-title"},fa={class:"text-14px font-bold"},va={class:"flex-1 overflow-auto"},ya={class:"config-footer"},ba=i(w({__name:"index",setup(e){const t=g(),a=N((()=>{switch(ue.value){case"trigger":return Bt;case"email":return Ft;case"action":return Jt;case"delay":return Qt;case"webhook":return ta;case"condition":return da;default:return ua}})),l=N((()=>{const e=ue.value;return e?r(e):""})),n=async()=>{await(t.value?.submit?.()),Be()};return(e,o)=>{const i=le;return C(),E("div",ca,[z("div",pa,[z("span",fa,D($(l)),1)]),z("div",va,[(C(),j(P($(a)),{ref_key:"compRef",ref:t,key:$(se)}))]),z("div",ya,[_(i,{class:"font-bold",size:"large",type:"primary",onClick:n},{default:U((()=>o[0]||(o[0]=[k("Save")]))),_:1,__:[0]})])])}}}),[["__scopeId","data-v-56456025"]]),ma={class:"mail-flow"},ga={class:"relative flex flex-1 overflow-auto"},_a={class:"absolute top-16px left-24px z-1000"},ka=w({__name:"index",setup(e){const t=V();t.params.id&&(oe.value=c(t.params.id));const a=M(),l=async()=>{try{await Be()}finally{setTimeout((()=>{a.go(-1)}),1e3)}},n=async()=>{const{message:e}=await m();ie.value=s(e)?e:[]},o=g(!1);return(async()=>{try{o.value=!0,await Promise.all([n(),qe()]),Fe()}finally{o.value=!1}})(),q((()=>{Fe(),Ge()})),(e,t)=>{const a=le,n=p;return C(),j(n,{class:"w-full h-full",show:$(o)},{default:U((()=>[z("div",ma,[z("div",ga,[z("div",_a,[_(a,{size:"large",class:"font-bold",secondary:"",onClick:l},{default:U((()=>t[0]||(t[0]=[k("Save and back")]))),_:1,__:[0]})]),_(Mt),_(ba)])])])),_:1},8,["show"])}}});e("default",i(ka,[["__scopeId","data-v-b7d1832f"]]))}}}));
