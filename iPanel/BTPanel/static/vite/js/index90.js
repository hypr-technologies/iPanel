import{d as e,m as a,g as l,_ as n,e as t,M as o,w as s,N as i,p as u,j as r,O as c}from"./page_layout.js?v=1752142539265";import{e as d,g as p,a as v,b as y,c as f}from"./campaign.js?v=1752142539265";import{r as m,Q as _,j as b,F as g,N as k,k as h,av as w,c as x,a1 as K,X as N,a2 as j,V as C,U,O as E,a3 as S,W as D,an as A,a6 as P,H as R,au as I,a4 as z,e as W,l as $,v as T,Z as O,aj as L,G as V}from"./vue.js?v=1752142539265";import{d as M}from"./public.js?v=1752142539265";import{cB as q,cC as B,bM as G,bS as F,b$ as H,cz as Y,cD as Z,aq as Q,cE as X,c1 as J,bZ as ee,ay as ae}from"./naive.js?v=1752142539265";import{_ as le}from"./index.vue_vue_type_script_setup_true_lang3.js?v=1752142539265";import"./common.js?v=1752142539265";import"./__commonjsHelpers__.js?v=1752142539265";import"./mail.js?v=1752142539265";const ne=m(0),te=m([]),oe=m([]),se=m(Date.now()),ie=m("root"),ue=m("trigger"),re=m({root:{nodeKey:"root",parentNodeKey:"",type:"trigger",id:0,parent_id:0,broken:!1,complete:!0,config:{type:"subscriber_added",group_ids:[]}}}),ce=m({}),de=m({}),pe=m({}),ve=m({}),ye=m({}),fe=m({}),me=m({trigger:re,email:ce,delay:de,webhook:pe,action:ve,abTest:ye,condition:fe}),_e=m({nodeKey:"",parentNodeKey:"",type:"trigger",next:null,id:0,parent_id:0,broken:!1,complete:!1}),be=m({..._e.value,config:{type:"subscriber_added",group_ids:[]}}),ge=m({..._e.value,email_id:0,name:"",subject:"",from:"",from_name:"",track_opens:!0,track_clicks:!0,track_unsubscribe:!0}),ke=m({..._e.value,value:0,unit:"days",description:""}),he=m({..._e.value,url:"",secret:""}),we=m({..._e.value,action:"add_to_subscribers",group_ids:[],description:""}),xe=m({..._e.value,name:"",branches:[]}),Ke=m({..._e.value,rules:[{type:null}],logic_type:"or",yes:[],no:[],description:""}),Ne=m({trigger:be,email:ge,delay:ke,webhook:he,action:we,abTest:xe,condition:Ke}),je={events:{},$on(e,a){this.events[e]?this.events[e].push(a):this.events[e]=[a]},$emit(e,a){this.events[e].forEach((e=>{e(a)}))},$unsubscribe(e){this.events[e]=[]}};function Ce(e,a){const n="trigger"===e?"root":l(),t=F(Ne.value[e]);return t.nodeKey=n,t.parentNodeKey=a,t.type=e,me.value[e][n]=t,t}function Ue(e,a){const l=Ce(e,a);return fe.value[a].no.unshift({type:e,key:l.nodeKey}),"condition"==e&&je.$on(l.nodeKey,(()=>{!function(e,a){const l=fe.value[a].no.findIndex((a=>a.key==e));fe.value[a].no.splice(l,1),je.$unsubscribe(e)}(l.nodeKey,a)})),l}function Ee(e,a){const l=fe.value[e],{parentNodeKey:n}=l;l[a].forEach((a=>{if("trigger"!==a.type){me.value[a.type][a.key].parentNodeKey=l.parentNodeKey}if("root"===n)oe.value.push({type:a.type,key:a.key});else{const l=fe.value[n],t=function(e){const a=fe.value[e],l=a.parentNodeKey,n=fe.value[l];return n.yes.some((a=>a.key===e))?"yes":"no"}(e);l[t].push({type:a.type,key:a.key})}}))}function Se(e,a){const l=oe.value.findIndex((e=>e.key==a));oe.value.splice(l,1),delete me.value[e][a]}function De(e){const a=m(1),l=me.value.condition[e],n=l.yes.length>0||l.no.length>0;M({title:"Please choose one of the following",width:400,content:()=>_(g,null,[n&&_(q,{value:a.value,onUpdateValue:e=>a.value=e},{default:()=>[_("div",null,[_(B,{value:1},{default:()=>[b("Delete both branches including all steps below.")]})]),_("div",{class:"mt-6px"},[_(B,{value:2},{default:()=>[b("Delete only YES branch including steps below.")]})]),_("div",{class:"mt-6px"},[_(B,{value:3},{default:()=>[b("Delete only NO branch including steps below.")]})])]}),!n&&_("div",null,[b("Do you really want to delete this step?")])]),onConfirm:async()=>{switch(a.value){case 1:Ae(e),Pe(e),Re(e);break;case 2:Ae(e),Ee(e,"no"),Re(e);break;case 3:Pe(e),Ee(e,"yes"),Re(e)}await Me(),ie.value===e&&(se.value=Date.now(),ie.value="root",ue.value="trigger")}})}function Ae(e){fe.value[e].yes.forEach((a=>{var l;"trigger"!==a.type&&("condition"!==a.type?Ie(a.type,e,a.key):(Ae(l=a.key),je.$emit(l)))}))}function Pe(e){fe.value[e].no.forEach((a=>{var l;"trigger"!==a.type&&("condition"!==a.type?ze(a.type,e,a.key):(Pe(l=a.key),je.$emit(l)))}))}function Re(e){const a=fe.value[e],{parentNodeKey:l}=a;if("root"===l)Se("condition",e);else{const a=fe.value[l];let n=a.yes.findIndex((a=>a.key===e));n>-1?a.yes.splice(n,1):(n=a.no.findIndex((a=>a.key===e)),a.no.splice(n,1))}}function Ie(e,a,l){const n=fe.value[a].yes.findIndex((e=>e.key==l));fe.value[a].yes.splice(n,1),delete me.value[e][l]}function ze(e,a,l){const n=fe.value[a].no.findIndex((e=>e.key==l));fe.value[a].no.splice(n,1),delete me.value[e][l]}function We(e,a){const l=fe.value[a].yes.findIndex((a=>a.key==e));fe.value[a].yes.splice(l,1),je.$unsubscribe(e)}function $e(e){qe();const{root:a,triggers:l}=e;G(l)&&l.length>0&&("subscriber_added"===l[0].type&&(me.value.trigger.root.complete=l[0].group_ids.length>0),me.value.trigger.root.config=l[0]),oe.value=Te(a,"root")}function Te(e,a,l=!1){const n=[];let t=e;for(;t;){const e=t.nodeKey,s={key:e,type:t.type};if(n.push(s),"condition"===t.type){l&&je.$on(e,(()=>{We(e,a)})),me.value.condition[e]=Oe(t,e);break}me.value[t.type][e]=(o=t,{...o,next:null}),t=t.next}var o;return n}function Oe(e,a){return{...e,nodeKey:a,yes:Te(e.yes,a,!0),no:Te(e.no,a,!0),next:null}}function Le(e){return e.reduceRight(((e,a)=>{const l=me.value[a.type][a.key],n=F(l);return"condition"===n.type?{...(t=n,{...t,yes:Le(t.yes),no:Le(t.no),next:null}),next:e}:{...n,next:e};var t}),null)}async function Ve(){const{message:a}=await p({id:ne.value});e(a)&&$e(a)}async function Me(l="save"){const n=function(){const e=Le(oe.value);return{triggers:[k(me.value.trigger.root.config)],root:e}}(),{message:t}=await d({id:ne.value,...n});if(e(t)){switch(l){case"save":a.success("Save successfully");break;case"del":a.success("Node deleted successfully");break;case"add":a.success("Node added successfully")}$e(t)}}async function qe(){oe.value=[],Object.keys(me.value).forEach((e=>{"trigger"!==e&&(me.value[e]={})}))}function Be(){se.value=Date.now(),ie.value="root",ue.value="trigger"}const Ge={class:"tool-icon"},Fe={class:"add-node"},He={class:"node-list"},Ye=["onClick"],Ze=t(h({__name:"ToolAdd",props:{parentKey:{},parentType:{},last:{type:Boolean}},emits:["addNode"],setup(e,{emit:a}){const l=e,t=a,o=w("popoverRef"),s=m([{type:"email",icon:"",desc:"Email"},{type:"delay",icon:"",desc:"Delay"},{type:"webhook",icon:"",desc:"Webhook"}]),i=x((()=>l.last?s.value:s.value.filter((e=>"condition"!==e.type))));return(e,a)=>{const s=n,u=H;return N(),K(u,{ref_key:"popoverRef",ref:o,trigger:"click"},{trigger:j((()=>[C("div",Ge,[_(s,{name:"base-add",size:"16"})])])),default:j((()=>[C("div",Fe,[a[0]||(a[0]=C("div",{class:"header"},"Add a next step to your workflow",-1)),C("div",He,[(N(!0),U(g,null,E(D(i),(e=>(N(),U("div",{key:e.type,class:"node-item",onClick:a=>{return n=e.type,t("addNode",n,l.parentKey),void(null==(s=o.value)||s.setShow(!1));var n,s}},S(e.desc),9,Ye)))),128))])])])),_:1},512)}}}),[["__scopeId","data-v-4e70f650"]]),Qe={class:"normal-node"},Xe={key:0,class:"font-bold"},Je=h({__name:"TriggerNode",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const a=e,l=x((()=>re.value[a.nodeKey])),n=x((()=>{const{config:e}=l.value;if("subscriber_added"===e.type&&0===e.group_ids.length)return"Set up workflow trigger";switch(e.type){case"subscriber_added":return"When a new email joins group(s) ";case"subscribed":return"When subscriber joins group(s) ";case"opened":return"When subscriber opens an email ";case"clicked":return"When subscriber clicks a link ".concat(e.link," ");case"unsubscribed":return"When subscriber unsubscribes ";default:return"Set up workflow trigger "}})),t=x((()=>{const{config:e}=l.value;switch(e.type){case"subscriber_added":case"subscribed":return o(e.group_ids);case"clicked":return e.link.url}return""})),o=e=>te.value.filter((a=>e.includes(a.id))).map((e=>e.mail_type)).join(", ");return(e,a)=>(N(),U("div",Qe,[C("span",null,S(D(n)),1),D(t)?(N(),U("span",Xe,S(D(t)),1)):A("",!0)]))}}),ea={class:"normal-node"},aa={class:"mt-8px"},la={key:0,class:"font-bold"},na=h({__name:"ActionNode",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const a=e,l=x((()=>ve.value[a.nodeKey])),t=x((()=>{if(l.value.complete&&l.value.group_ids.length>0)switch(l.value.action){case"add_to_subscribers":return"Add to group(s) ";case"remove_from_subscribers":return"Remove from group(s) ";case"mark_as_unsubscribe":return"Mark as unsubscribed"}return"Define action"})),o=x((()=>{if(l.value.complete)switch(l.value.action){case"add_to_subscribers":case"remove_from_subscribers":return s(l.value.group_ids)}return""})),s=e=>te.value.filter((a=>e.includes(a.id))).map((e=>e.mail_type)).join(", ");return(e,a)=>{const l=n;return N(),U("div",ea,[C("div",null,[_(l,{name:"flow-action",size:"16"})]),C("div",aa,[C("span",null,S(D(t)),1),D(o)?(N(),U("span",la,S(D(o)),1)):A("",!0)])])}}}),ta={class:"normal-node"},oa={class:"mt-8px"},sa=h({__name:"DelayNode",props:{type:{default:"delay"},nodeKey:{default:""}},setup(e){const a=e,l=x((()=>de.value[a.nodeKey])),t=x((()=>l.value.complete?"Wait ".concat(l.value.value," ").concat(l.value.unit):"Set delay"));return(e,a)=>{const l=n;return N(),U("div",ta,[C("div",null,[_(l,{name:"flow-delay",size:"16"})]),C("div",oa,S(D(t)),1)])}}}),ia={class:"normal-node"},ua={class:"mt-8px"},ra=t(h({__name:"EmailNode",props:{type:{default:"email"},nodeKey:{default:""}},setup(e){const a=e,l=x((()=>ce.value[a.nodeKey])),t=x((()=>l.value.complete?l.value.name:"Set email"));return(e,a)=>{const l=n;return N(),U("div",ia,[C("div",null,[_(l,{name:"flow-email",size:"16"})]),C("div",ua,S(D(t)),1)])}}}),[["__scopeId","data-v-8d632fb4"]]),ca={class:"normal-node"},da={class:"mt-8px"},pa=h({__name:"WebhookNode",props:{type:{default:"webhook"},nodeKey:{default:""}},setup(e){const a=e,l=x((()=>pe.value[a.nodeKey])),t=x((()=>l.value.complete?l.value.url:"Set webhook"));return(e,a)=>{const l=n;return N(),U("div",ca,[C("div",null,[_(l,{name:"flow-webhook",size:"16"})]),C("div",da,S(D(t)),1)])}}});const va=t({},[["render",function(e,a){return N(),U("div")}]]),ya=t(h({__name:"index",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const a=e,l=x((()=>{switch(a.type){case"trigger":return Je;case"delay":return sa;case"action":return na;case"email":return ra;case"webhook":return pa;default:return va}}));return(e,a)=>(N(),K(P(D(l)),{type:e.type,"node-key":e.nodeKey},null,8,["type","node-key"]))}}),[["__scopeId","data-v-1237c863"]]),fa={key:0,class:"line"},ma={class:"node-title"},_a={key:1,class:"text"},ba={class:"tools-box"},ga=t(h({__name:"NormalNode",props:{last:{type:Boolean,default:!1},type:{default:"trigger"},nodeKey:{default:"root"}},emits:["addNode","delNormalNode","selectNode"],setup(e,{emit:l}){const t=e,s=l,i=x((()=>"trigger"!==t.type)),u=x((()=>!c.value.complete)),r=x((()=>t.nodeKey===ie.value)),c=x((()=>me.value[t.type][t.nodeKey])),d=x((()=>t.type?o(t.type):""));function p(){s("selectNode",t.type,t.nodeKey)}function v(e){s("addNode",e,c.value)}function y(){if("email"===t.type){let e=!1;const l=me.value.email[t.nodeKey],n=me.value.condition,o=Object.entries(n);for(const[,a]of o){if(a.complete&&a.rules.length>0)for(const n of a.rules)if("workflow"===n.type&&n.node_id===l.id){e=!0;break}if(e)break}if(e)return void a.error("The email node is used in the condition node and cannot be deleted",{close:!0})}M({title:"Please confirm",content:"Do you really want to delete this step?",onConfirm:async()=>{s("delNormalNode",t.type,t.nodeKey),await Me("del")}})}return(e,a)=>{const l=n;return N(),U(g,null,[D(i)?(N(),U("div",fa)):A("",!0),C("div",{class:R(["node-box",{warning:D(u),action:D(r)}]),onClick:p},[C("div",ma,[D(u)?(N(),K(l,{key:0,class:"icon",name:"warning",color:"#FDCA62"})):A("",!0),D(i)?(N(),U("span",_a,S(D(d)),1)):A("",!0)]),D(i)?(N(),U("span",{key:0,class:"del-node",onClick:I(y,["stop"])},[_(l,{name:"flow-del"})])):A("",!0),_(ya,{type:e.type,"node-key":e.nodeKey},null,8,["type","node-key"])],2),C("div",ba,[a[0]||(a[0]=C("div",{class:"line"},null,-1)),C("div",null,[_(Ze,{last:e.last,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:v},null,8,["last","parent-type","parent-key"])])])],64)}}}),[["__scopeId","data-v-0b2e1f55"]]),ka={class:"node-title"},ha={class:"text-center"},wa={class:"mt-12px text-14px text-center"},xa={key:0,class:"font-bold"},Ka={class:"tools-box"},Na={class:"condition-box"},ja={class:"condition-item"},Ca={class:"condition-state success"},Ua={class:"tools-box"},Ea={key:0,class:"flow-tree"},Sa={class:"condition-item"},Da={class:"condition-state fail"},Aa={class:"tools-box"},Pa={key:0,class:"flow-tree"},Ra=t(h({name:"ConditionNode",__name:"ConditionNode",props:{type:{default:"trigger"},nodeKey:{default:"root"}},emits:["delCondition","selectNode"],setup(e,{emit:a}){const l=e,t=a,o=x((()=>!i.value.complete)),s=x((()=>l.nodeKey===ie.value)),i=x((()=>fe.value[l.nodeKey])),u=new Map([["clicked"," had any link clicked"],["link_clicked"," had a specific link clicked"],["link_not_clicked"," did not have a specific link clicked"],["opened"," was opened"],["not_opened"," was not opened"],["opened_with_not_clicked"," was opened with no links clicked"]]),r=x((()=>{const{rules:e}=i.value;if(e.length>0&&null!==e[0].type)switch(e[0].type){case"campaign":return e[0].campaign.name;case"workflow":return function(e,a){const l=me.value[a],n=Object.entries(l).filter((([,a])=>a.id===e));return n.length>0?n[0][1].name:""}(e[0].node_id,"email")}return""})),c=x((()=>{const{complete:e,rules:a,logic_type:l}=i.value;if(e&&a.length>0&&null!==a[0].type){let e=u.get(a[0].action)||"";return a.length>1&&(e+=" ".concat(l," +").concat(a.length-1," condition")),e}return"Define condition"})),d=()=>{t("selectNode","condition",l.nodeKey)},p=(e,a)=>{t("selectNode",e,a)};async function v(e,a){const l=function(e,a){const l=Ce(e,a);return fe.value[a].yes.unshift({type:e,key:l.nodeKey}),"condition"==e&&je.$on(l.nodeKey,(()=>{We(l.nodeKey,a)})),l}(e,a);await Me("add"),p(l.type,l.nodeKey)}async function y(e){const a=function(e,a){const l=Ce(e,a);return fe.value[a].yes.push({type:e,key:l.nodeKey}),l}(e,l.nodeKey);await Me("add"),p(a.type,a.nodeKey)}async function f(e,a){const l=Ue(e,a);await Me("add"),p(l.type,l.nodeKey)}async function m(e){const a=function(e,a){const l=Ce(e,a);return fe.value[a].no.push({type:e,key:l.nodeKey}),l}(e,l.nodeKey);await Me("add"),p(a.type,a.nodeKey)}function b(){t("delCondition",l.nodeKey)}function k(e){De(e)}function h(e,a){Ie(e,l.nodeKey,a),ie.value===a&&p("trigger","root")}function w(e,a){ze(e,l.nodeKey,a),ie.value===a&&p("trigger","root")}return(e,a)=>{const l=n,t=z("ConditionNode",!0);return N(),U(g,null,[a[8]||(a[8]=C("div",{class:"line"},null,-1)),C("div",{class:R(["node-box",{warning:D(o),action:D(s)}]),onClick:d},[C("div",ka,[D(o)?(N(),K(l,{key:0,class:"icon",name:"warning"})):A("",!0),a[0]||(a[0]=C("span",{class:"text"},"Condition",-1))]),C("span",{class:"del-node",onClick:I(b,["stop"])},[_(l,{name:"flow-del"})]),C("div",ha,[_(l,{size:"16",name:"flow-condition"})]),C("div",wa,[D(r)?(N(),U("span",xa,S(D(r)),1)):A("",!0),C("span",null,S(D(c)),1)])],2),C("div",Ka,[a[7]||(a[7]=C("div",{class:"line"},null,-1)),C("div",Na,[C("div",ja,[a[2]||(a[2]=C("div",{class:"horizontal-line right"},null,-1)),a[3]||(a[3]=C("div",{class:"line"},null,-1)),C("div",Ca,[_(l,{name:"flow-success",size:"20"})]),C("div",Ua,[a[1]||(a[1]=C("div",{class:"line"},null,-1)),C("div",null,[_(Ze,{last:0===D(i).yes.length,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:v},null,8,["last","parent-type","parent-key"])])]),D(i).yes.length?(N(),U("ul",Ea,[(N(!0),U(g,null,E(D(i).yes,((e,a)=>(N(),U("li",{key:e.key},["condition"==e.type?(N(),K(t,{key:0,type:"condition","node-key":e.key,onSelectNode:p,onDelCondition:k},null,8,["node-key"])):(N(),K(ga,{key:1,last:a===D(i).yes.length-1,type:e.type,"node-key":e.key,onAddNode:y,onSelectNode:p,onDelNormalNode:h},null,8,["last","type","node-key"]))])))),128))])):A("",!0)]),C("div",Sa,[a[5]||(a[5]=C("div",{class:"horizontal-line left"},null,-1)),a[6]||(a[6]=C("div",{class:"line"},null,-1)),C("div",Da,[_(l,{name:"flow-fail",size:"20"})]),C("div",Aa,[a[4]||(a[4]=C("div",{class:"line"},null,-1)),C("div",null,[_(Ze,{last:0===D(i).no.length,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:f},null,8,["last","parent-type","parent-key"])])]),D(i).no.length?(N(),U("ul",Pa,[(N(!0),U(g,null,E(D(i).no,((e,a)=>(N(),U("li",{key:e.key},["condition"==e.type?(N(),K(t,{key:0,type:"condition","node-key":e.key,onSelectNode:p,onDelCondition:k},null,8,["node-key"])):(N(),K(ga,{key:1,last:a===D(i).no.length-1,type:e.type,"node-key":e.key,onAddNode:m,onSelectNode:p,onDelNormalNode:w},null,8,["last","type","node-key"]))])))),128))])):A("",!0)])])])],64)}}}),[["__scopeId","data-v-fbf5dbc0"]]),Ia={class:"flow-container"},za={class:"flow-tree"},Wa=t(h({__name:"index",setup(e){async function a(e,a){const l=function(e,a){const l=Ce(e,"root");if(""===a)oe.value.unshift({type:e,key:l.nodeKey});else{const n=oe.value.findIndex((e=>e.key==a));oe.value.splice(n+1,0,{type:e,key:l.nodeKey})}return l}(e,a.nodeKey);await Me("add"),t(l.type,l.nodeKey)}function l(e){De(e)}function n(e,a){Se(e,a),ie.value===a&&t("trigger","root")}function t(e,a){se.value=Date.now(),ue.value=e,ie.value=a}return(e,o)=>(N(),U("div",Ia,[C("ul",za,[C("li",null,[_(ga,{last:0===D(oe).length,type:"trigger","node-key":"root",onSelectNode:t,onAddNode:a},null,8,["last"])]),(N(!0),U(g,null,E(D(oe),((e,o)=>(N(),U("li",{key:e.key},["condition"==e.type?(N(),K(Ra,{key:0,type:"condition","node-key":e.key,onSelectNode:t,onDelCondition:l},null,8,["node-key"])):(N(),K(ga,{key:1,last:o===D(oe).length-1,type:e.type,"node-key":e.key,onAddNode:a,onSelectNode:t,onDelNormalNode:n},null,8,["last","type","node-key"]))])))),128))])]))}}),[["__scopeId","data-v-459fbb31"]]),$a={class:"p-20px"},Ta=h({__name:"TriggerConfig",setup(e,{expose:a}){const l=w("formRef"),n=m({type:"subscriber_added",group_ids:[]}),t={group:{trigger:["change"],validator:()=>!!("subscriber_added"!==n.value.type&&"subscribed"!==n.value.type||n.value.group_ids.length)||new Error("Please select group")},link:{trigger:["input","blur"],validator:()=>!("clicked"===n.value.type&&!n.value.link.url)||new Error("Please enter link")}},o=m([{label:"When a new email joins group(s)",value:"subscriber_added"}]),s=m([]),i=e=>{switch(e){case"subscriber_added":case"subscribed":n.value={type:e,group_ids:[]};break;case"clicked":n.value={type:e,link:{url:""}};break;case"opened":case"unsubscribed":n.value={type:e}}};(()=>{if((async()=>{s.value=te.value.map((e=>({label:e.mail_type,value:e.id})))})(),ie.value){const e=re.value[ie.value];e&&(n.value=F(e.config))}})();return a({submit:async()=>{var e;if(await(null==(e=l.value)?void 0:e.validate()),ie.value){const e=re.value[ie.value];e.config=F(n.value),e.complete=!0}}}),(e,a)=>{const u=Z,r=Y,c=Q,d=X;return N(),U("div",$a,[_(d,{ref_key:"formRef",ref:l,model:D(n),rules:t},{default:j((()=>[_(r,{label:"Trigger"},{default:j((()=>[_(u,{value:D(n).type,options:D(o),"onUpdate:value":i},null,8,["value","options"])])),_:1}),"subscriber_added"===D(n).type||"subscribed"===D(n).type?(N(),K(r,{key:0,label:"Group",path:"group"},{default:j((()=>[_(u,{value:D(n).group_ids,"onUpdate:value":a[0]||(a[0]=e=>D(n).group_ids=e),multiple:!0,filterable:!0,options:D(s)},null,8,["value","options"])])),_:1})):A("",!0),"clicked"===D(n).type?(N(),K(r,{key:1,label:"Link",path:"link"},{default:j((()=>[_(c,{value:D(n).link.url,"onUpdate:value":a[1]||(a[1]=e=>D(n).link.url=e)},null,8,["value"])])),_:1})):A("",!0)])),_:1},8,["model"])])}}}),Oa={class:"p-20px"},La=h({__name:"EmailConfig",setup(a,{expose:l}){const n=w("formRef"),t=W({name:"",subject:"",from_name:"",from:"",email_id:null,track_opens:!0,track_clicks:!0,track_unsubscribe:!0}),o=m([]),u={email_id:{trigger:["change"],validator:()=>!!t.email_id||new Error("Please select email template")},name:{trigger:["blur","input"],validator:()=>!!t.name||new Error("Please enter email name")},subject:{trigger:["blur","input"],validator:()=>!!t.subject||new Error("Please enter email subject")},from_name:{trigger:["blur","input"],validator:()=>!!t.from_name||new Error("Please enter sender name")},from:{trigger:["blur","input"],validator:()=>t.from?!!i(t.from)||new Error("Please enter a valid email address"):new Error("Please enter sender email")}},r=(a,l)=>{const{data:n}=l;e(n)&&(t.from_name=n.full_name)},c=async()=>{const{message:e}=await v();s(e)&&e.length>0&&(o.value=e.map((e=>({label:e.name,value:e.id}))))};(()=>{if(c(),ie.value){const e=ce.value[ie.value];t.name=e.name,t.subject=e.subject,t.from_name=e.from_name,t.from=e.from,t.email_id=0===e.email_id?null:e.email_id,t.track_opens=e.track_opens,t.track_clicks=e.track_clicks,t.track_unsubscribe=e.track_unsubscribe}})();return l({submit:async()=>{var e;if(await(null==(e=n.value)?void 0:e.validate()),ie.value){const e=ce.value[ie.value];e.name=t.name,e.subject=t.subject,e.from_name=t.from_name,e.from=t.from,e.email_id=null===t.email_id?0:t.email_id,e.track_opens=t.track_opens,e.track_clicks=t.track_clicks,e.track_unsubscribe=t.track_unsubscribe,e.complete=!0}}}),(e,a)=>{const l=Q,s=Y,i=Z,c=J,d=X;return N(),U("div",Oa,[_(d,{ref_key:"formRef",ref:n,model:D(t),rules:u},{default:j((()=>[_(s,{label:"Email name",path:"name"},{default:j((()=>[_(l,{value:D(t).name,"onUpdate:value":a[0]||(a[0]=e=>D(t).name=e),placeholder:"Name"},null,8,["value"])])),_:1}),_(s,{label:"Sender email",path:"from"},{default:j((()=>[_(le,{value:D(t).from,"onUpdate:value":a[1]||(a[1]=e=>D(t).from=e),"is-init":!0,placeholder:"Sender email",onChange:r},null,8,["value"])])),_:1}),_(s,{label:"Who is it from?",path:"from_name"},{default:j((()=>[_(l,{value:D(t).from_name,"onUpdate:value":a[2]||(a[2]=e=>D(t).from_name=e),placeholder:"Sender name"},null,8,["value"])])),_:1}),_(s,{label:"Subject",path:"subject"},{default:j((()=>[_(l,{value:D(t).subject,"onUpdate:value":a[3]||(a[3]=e=>D(t).subject=e),placeholder:"Email subject"},null,8,["value"])])),_:1}),_(s,{label:"Template",path:"email_id"},{default:j((()=>[_(i,{value:D(t).email_id,"onUpdate:value":a[4]||(a[4]=e=>D(t).email_id=e),options:D(o)},null,8,["value","options"])])),_:1}),A("",!0),A("",!0),_(s,{label:"Whether to enable the unsubscribe link and collect unsubscribe statistics"},{default:j((()=>[_(c,{value:D(t).track_unsubscribe,"onUpdate:value":a[7]||(a[7]=e=>D(t).track_unsubscribe=e)},null,8,["value"])])),_:1})])),_:1},8,["model"])])}}}),Va={class:"p-20px"},Ma={class:"w-140px mr-12px"},qa={class:"flex-1"},Ba=h({__name:"DelayConfig",setup(e,{expose:a}){const l=w("formRef"),n=W({value:0,unit:"days"}),t=m([{label:"second(s)",value:"seconds"},{label:"minute(s)",value:"minutes"},{label:"hour(s)",value:"hours"},{label:"day(s)",value:"days"}]),o={value:{trigger:["blur","input"],validator:()=>n.value<=0?new Error("Value must be at least 1"):"days"===n.unit&&n.value>700?new Error("Value must be less than 700"):!!Number.isInteger(n.value)||new Error("Value must be an integer")}};(()=>{if(ie.value){const e=de.value[ie.value];n.value=e.value,n.unit=e.unit}})();return a({submit:async()=>{var e;if(await(null==(e=l.value)?void 0:e.validate()),ie.value){const e=de.value[ie.value];e.value=n.value,e.unit=n.unit,e.complete=!0}}}),(e,a)=>{const s=ee,i=Z,u=Y,r=X;return N(),U("div",Va,[_(r,{ref_key:"formRef",ref:l,model:D(n),rules:o},{default:j((()=>[_(u,{label:"Wait",path:"value"},{default:j((()=>[C("div",Ma,[_(s,{value:D(n).value,"onUpdate:value":a[0]||(a[0]=e=>D(n).value=e),min:0,"show-button":!1},null,8,["value"])]),C("div",qa,[_(i,{value:D(n).unit,"onUpdate:value":a[1]||(a[1]=e=>D(n).unit=e),options:D(t)},null,8,["value","options"])])])),_:1})])),_:1},8,["model"])])}}}),Ga={class:"p-20px"},Fa=h({__name:"ActionConfig",setup(e,{expose:a}){const l=w("formRef"),n=W({action:"add_to_subscribers",group_ids:[]}),t=m([{label:"添加到联系人列表中",value:"add_to_subscribers"},{label:"从联系人列表中删除",value:"remove_from_subscribers"},{label:"标记为已退订",value:"mark_as_unsubscribe"}]),o=m([]),s={group:{trigger:["change"],validator:()=>!!("add_to_subscribers"!==n.action&&"remove_from_subscribers"!==n.action||n.group_ids.length)||new Error("Please select group")}},i=()=>{n.group_ids=[]};(()=>{if((async()=>{o.value=te.value.map((e=>({label:e.mail_type,value:e.id})))})(),ie.value){const e=ve.value[ie.value];n.action=e.action,n.group_ids=F(e.group_ids)}})();return a({submit:async()=>{var e;if(await(null==(e=l.value)?void 0:e.validate()),ie.value){const e=ve.value[ie.value];e.action=n.action,e.group_ids=F(n.group_ids),e.complete=!0}}}),(e,a)=>{const u=Z,r=Y,c=X;return N(),U("div",Ga,[_(c,{ref_key:"formRef",ref:l,model:D(n),rules:s},{default:j((()=>[_(r,{label:"Choose an action"},{default:j((()=>[_(u,{value:D(n).action,"onUpdate:value":[a[0]||(a[0]=e=>D(n).action=e),i],options:D(t)},null,8,["value","options"])])),_:1}),$(_(r,{label:"Group",path:"group"},{default:j((()=>[_(u,{value:D(n).group_ids,"onUpdate:value":a[1]||(a[1]=e=>D(n).group_ids=e),multiple:!0,filterable:!0,options:D(o)},null,8,["value","options"])])),_:1},512),[[T,"add_to_subscribers"===D(n).action||"remove_from_subscribers"===D(n).action]])])),_:1},8,["model"])])}}}),Ha={class:"p-20px"},Ya=h({__name:"WebhookConfig",setup(e,{expose:a}){const l=w("formRef"),n=W({url:"",secret:""}),t={url:{required:!0,trigger:["blur","input"],message:"Please enter webhook URL"},secret:{required:!0,trigger:["blur","input"],message:"Please enter secret key"}};return(()=>{if(ie.value){const e=pe.value[ie.value];n.url=e.url,n.secret=e.secret}})(),a({submit:async()=>{var e;if(await(null==(e=l.value)?void 0:e.validate()),ie.value){const e=pe.value[ie.value];e.url=n.url,e.secret=n.secret,e.complete=!0}}}),(e,a)=>{const o=Q,s=Y,i=X;return N(),U("div",Ha,[_(i,{ref_key:"formRef",ref:l,model:D(n),rules:t},{default:j((()=>[_(s,{label:"Webhook URL",path:"url"},{default:j((()=>[_(o,{value:D(n).url,"onUpdate:value":a[0]||(a[0]=e=>D(n).url=e),placeholder:""},null,8,["value"])])),_:1}),_(s,{label:"Secret Key",path:"secret"},{default:j((()=>[_(o,{value:D(n).secret,"onUpdate:value":a[1]||(a[1]=e=>D(n).secret=e),placeholder:""},null,8,["value"])])),_:1})])),_:1},8,["model"])])}}}),Za={class:"p-20px"},Qa={class:"flex-1"},Xa={class:"mt-12px"},Ja={class:"mt-12px"},el={class:"condition-box mt-12px"},al={class:"flex justify-between items-center mb-16px"},ll=t(h({__name:"ConditionConfig",setup(a,{expose:l}){const n=w("formRef"),t=W({logic_type:"or",rules:[{type:null}]}),o=m([{label:"Campaign activity",value:"campaign"},{label:"Workflow activity",value:"workflow"}]),i=m([]),r=m([]),c=m([{label:"had any link clicked",value:"clicked"},{label:"had a specific link clicked",value:"link_clicked"},{label:"did not have a specific link clicked",value:"link_not_clicked"},{label:"was opened",value:"opened"},{label:"was not opened",value:"not_opened"},{label:"was opened with no links clicked",value:"opened_with_not_clicked"}]),d=e=>({trigger:"change",validator:()=>!!t.rules[e].type||new Error("Please select type")}),p=e=>({trigger:"change",validator:()=>{const a=t.rules[e];return!("campaign"===a.type&&!a.campaign.id)||new Error("Please select campaign")}}),v=e=>({trigger:"change",validator:()=>{const a=t.rules[e];return!!("workflow"!==a.type&&"campaign"!==a.type||a.action)||new Error("Please select action")}}),f=e=>({trigger:"change",validator:()=>{const a=t.rules[e];return!!("workflow"!==a.type&&"campaign"!==a.type||"link_clicked"!==a.action||a.link.url)||new Error("Please input link")}}),k=()=>{t.rules.push({type:null})};(()=>{if((async()=>{const{message:e}=await y();s(e)&&(i.value=e.map((e=>({value:e.id,data:e,label:e.subject||e.task_name}))))})(),(()=>{const e=oe.value.filter((e=>"email"===e.type)).map((e=>ce.value[e.key])).filter((e=>e.complete&&0!==e.id));r.value=e.map((e=>({label:e.name,value:e.id})))})(),ie.value){const e=fe.value[ie.value];t.logic_type=e.logic_type,t.rules=F(e.rules)}})();return l({submit:async()=>{var e;if(await(null==(e=n.value)?void 0:e.validate()),ie.value){const e=fe.value[ie.value];e.logic_type=t.logic_type,e.rules=F(t.rules),e.complete=!0}}}),(a,l)=>{const s=B,y=q,m=u,h=ae,w=Z,x=Y,P=Q,R=X;return N(),U("div",Za,[_(R,{ref_key:"formRef",ref:n,model:D(t)},{default:j((()=>[_(x,{label:"Create a condition"},{default:j((()=>[C("div",Qa,[l[6]||(l[6]=C("div",{class:"text-desc"}," Add up to 5 conditions. Define whether any or all of them must be applicable, for the condition to be met. ",-1)),_(y,{value:D(t).logic_type,"onUpdate:value":l[0]||(l[0]=e=>D(t).logic_type=e)},{default:j((()=>[C("div",Xa,[_(s,{value:"or"},{default:j((()=>l[1]||(l[1]=[C("div",null,"Any rule",-1),C("div",{class:"mt-8px text-desc"}," Select one or a few conditions where ANY rule can match the criteria. ",-1)]))),_:1,__:[1]})]),C("div",Ja,[_(s,{value:"and"},{default:j((()=>l[2]||(l[2]=[C("div",null,"All rules",-1),C("div",{class:"mt-8px text-desc"}," Select one or a few conditions where ALL rules must match the criteria. ",-1)]))),_:1,__:[2]})])])),_:1},8,["value"]),(N(!0),U(g,null,E(D(t).rules,((a,n)=>(N(),U(g,{key:n},[0!==n?(N(),K(m,{key:0,class:"mt-12px!","title-placement":"left"},{default:j((()=>[b(S(D(t).logic_type),1)])),_:1})):A("",!0),C("div",el,[C("div",al,[l[4]||(l[4]=C("span",null,"Condition",-1)),D(t).rules.length>1?(N(),K(h,{key:0,size:"small",onClick:e=>(e=>{t.rules.splice(e,1)})(n)},{default:j((()=>l[3]||(l[3]=[b("Delete")]))),_:2,__:[3]},1032,["onClick"])):A("",!0)]),_(x,{"show-label":!1,path:"rules[".concat(n,"].type"),rule:d(n)},{default:j((()=>[_(w,{value:a.type,options:D(o),"onUpdate:value":e=>((e,a)=>{switch(e){case"campaign":t.rules[a]={type:"campaign",action:null,campaign:{id:null,name:""},link:{url:""}};break;case"workflow":t.rules[a]={type:"workflow",node_id:null,action:null,link:{url:""}}}})(e,n)},null,8,["value","options","onUpdate:value"])])),_:2},1032,["path","rule"]),"campaign"===a.type?(N(),K(x,{key:0,"show-label":!1,path:"rules[".concat(n,"].campaign.id"),rule:p(n)},{default:j((()=>[_(w,{value:a.campaign.id,"onUpdate:value":[e=>a.campaign.id=e,(a,l)=>((a,l)=>{e(l.data)&&"campaign"===t.rules[a].type&&(t.rules[a].campaign.name=l.data.subject)})(n,l)],options:D(i)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path","rule"])):A("",!0),"workflow"===a.type?(N(),K(x,{key:1,"show-label":!1,path:"rules[".concat(n,"].workflow.node_id")},{default:j((()=>[_(w,{value:a.node_id,"onUpdate:value":e=>a.node_id=e,options:D(r)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path"])):A("",!0),"campaign"===a.type&&a.campaign.id||"workflow"===a.type&&a.node_id?(N(),U(g,{key:2},[_(x,{"show-label":!1,path:"rules[".concat(n,"].action"),rule:v(n)},{default:j((()=>[_(w,{value:a.action,"onUpdate:value":e=>a.action=e,options:D(c)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path","rule"]),$(_(x,{"show-label":!1,path:"rules[".concat(n,"].link.url"),rule:f(n)},{default:j((()=>[_(P,{value:a.link.url,"onUpdate:value":e=>a.link.url=e,placeholder:"Please input link"},null,8,["value","onUpdate:value"])])),_:2},1032,["path","rule"]),[[T,"link_clicked"===a.action]])],64)):A("",!0)])],64)))),128)),_(h,{class:"mt-12px",size:"small",onClick:k},{default:j((()=>l[5]||(l[5]=[b(" Add another condition ")]))),_:1,__:[5]})])])),_:1})])),_:1},8,["model"])])}}}),[["__scopeId","data-v-00442d4d"]]);const nl=t({},[["render",function(e,a){return N(),U("div")}]]),tl={class:"flow-config"},ol={class:"config-title"},sl={class:"text-14px font-bold"},il={class:"flex-1 overflow-auto"},ul={class:"config-footer"},rl=t(h({__name:"index",setup(e){const a=m(),l=x((()=>{switch(ue.value){case"trigger":return Ta;case"email":return La;case"action":return Fa;case"delay":return Ba;case"webhook":return Ya;case"condition":return ll;default:return nl}})),n=x((()=>{const e=ue.value;return e?o(e):""})),t=async()=>{var e,l;await(null==(l=null==(e=a.value)?void 0:e.submit)?void 0:l.call(e)),Me()};return(e,o)=>{const s=ae;return N(),U("div",tl,[C("div",ol,[C("span",sl,S(D(n)),1)]),C("div",il,[(N(),K(P(D(l)),{ref_key:"compRef",ref:a,key:D(se)}))]),C("div",ul,[_(s,{class:"font-bold",size:"large",type:"primary",onClick:t},{default:j((()=>o[0]||(o[0]=[b("Save")]))),_:1,__:[0]})])])}}}),[["__scopeId","data-v-56456025"]]),cl={class:"mail-flow"},dl={class:"relative flex flex-1 overflow-auto"},pl={class:"absolute top-16px left-24px z-1000"},vl=t(h({__name:"index",setup(e){const a=O();a.params.id&&(ne.value=r(a.params.id));const l=L(),n=async()=>{try{await Me()}finally{setTimeout((()=>{l.go(-1)}),1e3)}},t=async()=>{const{message:e}=await f();te.value=s(e)?e:[]},o=m(!1);return(async()=>{try{o.value=!0,await Promise.all([t(),Ve()]),Be()}finally{o.value=!1}})(),V((()=>{Be(),qe()})),(e,a)=>{const l=ae,t=c;return N(),K(t,{class:"w-full h-full",show:D(o)},{default:j((()=>[C("div",cl,[C("div",dl,[C("div",pl,[_(l,{size:"large",class:"font-bold",secondary:"",onClick:n},{default:j((()=>a[0]||(a[0]=[b("Save and back")]))),_:1,__:[0]})]),_(Wa),_(rl)])])])),_:1},8,["show"])}}}),[["__scopeId","data-v-b7d1832f"]]);export{vl as default};


